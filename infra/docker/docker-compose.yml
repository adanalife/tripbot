version: '3.7'

services:
  tripbot:
    image: adanalife/tripbot
    hostname: tripbot
    env_file:
      - infra/docker/env.docker
    build:
      context: .
      dockerfile: infra/docker/tripbot/Dockerfile
    depends_on:
      - db
    ports:
      # this should match the TRIPBOT_SERVER_PORT env var
      - "8080"
    volumes:
      - .:/go/src/github.com/adanalife/tripbot
      #TODO: do we even need this?
      - ./assets/video:/opt/data/Dashcam/_all:ro
    restart: unless-stopped

  obs:
    privileged: true
    image: adanalife/obs
    hostname: obs
    env_file:
      - infra/docker/env.docker
    build:
      context: .
      dockerfile: infra/docker/obs/Dockerfile
    # depends_on:
    #   - mpd
    ports:
      # this should match the VLC_SERVER_HOST env var
      - "8080"
      - "5902:5900"
    environment:
      DISPLAY: ":0.0"
      XDG_RUNTIME_DIR: "/root/.cache/xdgr"
      # hack to make fontconfig happy
      FONTCONFIG_PATH: "/etc/fonts"
      STREAM_KEY: "${STREAM_KEY}"
    volumes:
      - .:/go/src/github.com/adanalife/tripbot
      - ./assets/video:/opt/data/Dashcam/_all:ro
    restart: unless-stopped

  db:
    image: postgres:12
    restart: always
    ports:
      - "5432"
    environment:
      POSTGRES_PASSWORD: "${DATABASE_PASS}"
      POSTGRES_USER: "${DATABASE_USER}"
      POSTGRES_DB: "${DATABASE_DB}"
    # volumes:
    #   - ./infra/docker/init.sql:/docker-entrypoint-initdb.d/init.sql
    #   - ./tmp/data:/var/lib/postgresql/data

  mpd:
    image: wernight/mopidy
    ports:
      - "6600:6601"
    volumes:
      - ./infra/mopidy.conf:/config/mopidy.conf
    # devices:
    #   - /dev/snd
    restart: unless-stopped
    # hide output
    logging:
      driver: none

  migrate:
    image: migrate/migrate
    depends_on:
      - db
    volumes:
      - ./db/migrate:/migrations
    command: [
      "-path", "/migrations",
      "-database",  "postgres://${DATABASE_USER}:${DATABASE_PASS}@${DATABASE_HOST}:5432/${DATABASE_DB}?sslmode=disable",
      "up"
    ]
    restart: on-failure

  seed:
    image: adanalife/tripbot
    env_file:
      - infra/docker/env.docker
    depends_on:
      - migrate
    restart: on-failure
    entrypoint: bash -c "infra/docker/bin/seed-db.sh"
    volumes:
      - .:/go/src/github.com/adanalife/tripbot
