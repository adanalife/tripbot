version: '3.7'

services:
  tripbot:
    env_file:
      - infra/docker/env.docker
    build:
      context: .
      dockerfile: infra/docker/tripbot/Dockerfile
    depends_on:
      - db
      - obs
      - mpd
    ports:
      # this should match the TRIPBOT_SERVER_PORT env var
      - "8080"
    #TODO: do we even need this?
    volumes:
      - ./assets/video:/danalol/Dashcam/_all
    restart: unless-stopped

  obs:
    env_file:
      - infra/docker/env.docker
    build:
      context: .
      dockerfile: infra/docker/obs/Dockerfile
    depends_on:
      - ffmpeg
    ports:
      # this should match the VLC_SERVER_HOST env var
      - "8088"
      - "5902:5900"
    environment:
      STREAM_KEY: "${STREAM_KEY}"
    volumes:
      - .:/go/src/github.com/dmerrick/tripbot
      - ./assets/video:/danalol/Dashcam/_all
    restart: unless-stopped

  ffmpeg:
    build:
      context: .
      dockerfile: infra/docker/obs/Dockerfile.nvidia

  db:
    image: postgres:12
    restart: always
    ports:
      - "5432"
    environment:
      POSTGRES_PASSWORD: "${DATABASE_PASS}"
      POSTGRES_USER: "${DATABASE_USER}"
      POSTGRES_DB: "${DATABASE_DB}"
    # volumes:
    #   - ./infra/docker/init.sql:/docker-entrypoint-initdb.d/init.sql
    #   - ./tmp/data:/var/lib/postgresql/data

  mpd:
    image: wernight/mopidy
    ports:
      - "6600:6601"
    volumes:
      - ./infra/mopidy.conf:/config/mopidy.conf
    # devices:
    #   - /dev/snd
    restart: unless-stopped

  migrate:
    image: migrate/migrate
    depends_on:
      - db
    volumes:
      - ./db/migrate:/migrations
    command: ["-path", "/migrations", "-database",  "postgres://${DATABASE_USER}:${DATABASE_PASS}@${DATABASE_HOST}:5432/${DATABASE_DB}?sslmode=disable", "up"]
    restart: on-failure
